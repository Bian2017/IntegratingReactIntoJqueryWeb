
性能优化
---

项目背景：原项目是典型的MVC结构，前端页面的开发采用的是jQuery + ejs，通过NodeJS进行了路由跳转以及服务端渲染。

个人对jQuery用起来不是特别熟练，维护起来分外痛苦。其次，产品经理设计产品原型采用的是Ant Design，使用jQuery很难做到与产品设计的统一。

由于原项目已经很庞大，对项目代码进行重构不太现实，故只能针对后续需求的迭代开发采用React。在jQuery的基础上再采用React进行开发，会遇到不少性能问题，目前采用了如下方式进行了性能优化：

## 1. 提取公共文件

```JS
output: {
  path: path.join(__dirname, '../public/dist/work'),
  filename: "[name].js",
  chunkFilename: "[name].[chunkhash:8].js"    //不宜设置成[name].[hash:8].js
}
```

### 1.1 文件Hash摘要

在vendor.js中打包所有稳定不易变化的逻辑，比如应用的依赖库。在common.js中打包业务代码中的公共部分。针对这两个文件，加上hash码，并在node端设置浏览器缓存(max-age)。

+ hash：计算所有 chunks 的 hash；
+ chunkhash：为每个 chunk 计算hash；

第一种是每次编译生成一个唯一 hash，所有资源全打上同一个 hash。

第二种是 webpack 为每个 chunk 资源都生成与其内容相关的 hash 摘要，为不同的资源打上不同的 hash。

在本项目中，希望vendor.js存储react、react-dom等第三方库，而这些第三方库往往是稳定不易变化的，如果设置成[name].[hash:8].js，则每次业务代码变动都会导致文件Hash摘要发生变化，这样就失去了缓存的意义。


> 不要在开发环境使用 [chunkhash]/[hash]/[contenthash]，因为不需要在开发环境做持久缓存，而且这样会增加编译时间，开发环境用 [name] 就可以了。


值得注意的是：chunkhash并不稳定

### 1.2 代码分割

webpack 4 移除 CommonsChunkPlugin，取而代之的是两个新的配置项（optimization.splitChunks 和 optimization.runtimeChunk）

```JS
optimization: {
  splitChunks: {
    cacheGroups: {
      commons: {
        chunks: "initial",
        name: 'common',
        minChunks: 2,
        maxInitialRequests: 5, // The default limit is too small to showcase the effect
        minSize: 0 // This is example is too small to create commons chunks
      },
      // 提取常用依赖作为vendor
      vendor: {
        test: /react|react-dom|redux|react-redux|redux-thunk|moment|axios/,      
        chunks: "all",
        name: "vendor",
        priority: 10,
        enforce: true
      }
    }
  }
  }
```

### 1.3 自动载入配置

原项目针对页面标签head里的内容进行了统一处理，然后每个页面通过"include src/head.html"来包含head标签里的内容。

**head.html**

```EJS
<!DOCTYPE html> 
<html lang="zh-cn"> 
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> 
  <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="renderer" content="webkit">
  <meta name="viewport" content="width=device-width, initial-scale=1"> 
  <meta name="keywords" content> 
  <meta name="description" content> 
  <title><%=LOCAL['CNAME']%> 后台管理</title>
  ***
</head>
```

每个页面通过ejs语法提供的include来包含head标签内容。

```EJS
<% include src/head.html %>
<div class="main-body">
  XXXX
</div> 
```

由于vendor和common文件每次编译，文件后缀哈希值都会产生变化，每次手动载入不太现实。而html-webpack-plugin插件除了可以生成一个全新的html文件外，还可以根据提供的模板文件生成一个定制的HTML文件。

由于本项目已经有了head标签内容，而每个页面的body内容又不相同，故只能通过定制模板文件方式，来实现vendor、common这两个文件的自动载入。具体方式：定制模板文件([官方参考模板](https://github.com/jaketrent/html-webpack-template/blob/86f285d5c790a6c15263f5cc50fd666d51f974fd/index.html))，用于生成包含vendor、common这两个文件的script标签，然后在head.html中用ejs语法提供的include将生成的html文件包含进来，这样就无需每次手动载入了。

**定制模板文件：react-header-debugger.html**

```EJS
<% for (var css in htmlWebpackPlugin.files.css) { %>
  <link href="/dist/work/<%= htmlWebpackPlugin.files.css[css] %>" rel="stylesheet">
<% } %>

<% for (var chunk in htmlWebpackPlugin.files.chunks) { %>
  <script src="/combo??/public/dist/work/<%= htmlWebpackPlugin.files.chunks[chunk].entry %>"></script>
<% } %>
```

**html-webpack-plugin插件配置**

```JS
new HtmlWebpackPlugin({
  inject: false,
  template: 'src/html/react-head-debugger.html',
  filename: 'react-head.html',
  chunks: ['common', 'vendor']  
})
```

字段template:

    存放本地模板文件的位置。

    注意:
    1. template配置项在html文件使用file-loader时，其所指定的位置找不到，导致生成的html文件内容不是期望的内容。
    2. 为template指定的模板文件没有指定任何loader的话，默认使用ejs-loader。如template: './index.html'，若没有为.html指定任何loader就使用ejs-loader。

字段inject:

    inject：向template或者templateContent中注入所有静态资源，不同的配置值注入的位置不经相同。

    1. true或者body：所有JavaScript资源插入到body元素的底部；
    2. head: 所有JavaScript资源插入到head元素中；
    3. false: 所有静态资源CSS和JavaScript都不会注入到模板文件中；

字段chunks:

    允许插入到模板中的一些chunk，不配置此项默认会将entry中所有的thunk注入到模板中。在配置多个页面时，每个页面注入的thunk应该是不相同的，需要通过该配置为不同页面注入不同的thunk。

**生成HTML文件: react-head.html**

```HTML
<link href="/dist/work/common.css" rel="stylesheet">
<script src="/combo??/public/dist/work/vendor.cc7cda71.js"></script>
<script src="/combo??/public/dist/work/common.37bb6ff3.js"></script>
```

**修改head.html**

```EJS
<!DOCTYPE html> 
<html lang="zh-cn"> 
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> 
  <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="renderer" content="webkit">
  <meta name="viewport" content="width=device-width, initial-scale=1"> 
  <meta name="keywords" content> 
  <meta name="description" content> 
  <title><%=LOCAL['CNAME']%> 后台管理</title>
  ***

  <% include src/react-head.html %>  <!--通过ejs将vendor、common文件包含进来-->
</head>
```

### Ant Design按需加载


###  combo服务

### 浏览器缓存

304